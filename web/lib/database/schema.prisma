generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["views", "multiSchema"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
  schemas   = ["web", "public"]
}

model Draft {
  id              Int      @id @default(autoincrement())
  title           String
  description     String
  blocks          String?
  tagline         String?
  image           String
  users           String[]
  isPrivate       Boolean  @default(true)
  isOnchain       Boolean  @default(false)
  updatedAt       DateTime @updatedAt
  createdAt       DateTime @default(now())
  flowId          String
  isFlow          Boolean  @default(false)
  transactionHash String?

  flow Grant @relation(fields: [flowId], references: [id])

  @@index([isPrivate])
  @@index([isOnchain])
  @@index([flowId])
  @@index([createdAt])
  @@map("Draft")
  @@schema("web")
}

model Cast {
  hash      String   @id
  fid       Int
  channelId String
  text      String
  images    String[]
  videos    String[]
  createdAt DateTime
  grantId   String?

  grant Grant?        @relation(fields: [grantId], references: [id])
  user  FarcasterUser @relation(fields: [fid], references: [fid])

  @@index([fid])
  @@index([channelId])
  @@index([createdAt])
  @@index([grantId])
  @@map("Cast")
  @@schema("web")
}

model FarcasterUser {
  fid         Int      @id
  username    String
  displayName String
  imageUrl    String
  addresses   String[]

  casts Cast[]

  @@map("FarcasterUser")
  @@schema("web")
}

model Comment {
  id            String   @id @default(cuid())
  content       String
  author        String
  commentableId String
  parentId      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  parent  Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies Comment[] @relation("CommentReplies")

  @@index([commentableId])
  @@index([parentId])
  @@index([author])
  @@map("Comment")
  @@schema("web")
}

model DerivedData {
  id        String   @id @default(cuid())
  grantId   String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  grant     Grant    @relation(fields: [grantId], references: [id])

  @@index([grantId])
  @@map("DerivedData")
  @@schema("web")

  // derived data here (generated from ai etc.)
  minimumSalary Int?
  template      String?
}


model Application {
  id          String   @id
  flowId      String
  messages    Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        String
  attachments Json?

  @@index([user])
  @@index([flowId])
  @@map("Application")
  @@schema("web")
}

view Grant {
  id                               String  @id
  recipient                        String
  flowId                           String
  submitter                        String
  parentContract                   String
  isTopLevel                       Int
  isFlow                           Int
  title                            String
  description                      String
  image                            String
  tagline                          String?
  url                              String?
  isRemoved                        Int
  isActive                         Int
  votesCount                       String
  monthlyIncomingFlowRate          String
  monthlyIncomingBaselineFlowRate  String
  monthlyIncomingBonusFlowRate     String
  monthlyOutgoingFlowRate          String
  monthlyRewardPoolFlowRate        String
  monthlyBaselinePoolFlowRate      String
  monthlyBonusPoolFlowRate         String
  bonusMemberUnits                 String
  baselineMemberUnits              String
  totalEarned                      String
  activeRecipientCount             Int
  awaitingRecipientCount           Int
  challengedRecipientCount         Int
  tcr                              String  @unique
  erc20                            String  @unique
  arbitrator                       String  @unique
  tokenEmitter                     String  @unique
  status                           Int
  challengePeriodEndsAt            Int
  isDisputed                       Int
  isResolved                       Int
  evidenceGroupID                  String  @unique
  createdAt                        Int
  updatedAt                        Int
  baselinePool                     String
  bonusPool                        String
  managerRewardPool                String
  superToken                       String
  managerRewardSuperfluidPool      String
  managerRewardPoolFlowRatePercent Int
  baselinePoolFlowRatePercent      Int

  flow         Grant         @relation("Subgrants", fields: [flowId], references: [id])
  subgrants    Grant[]       @relation("Subgrants")
  drafts       Draft[]
  disputes     Dispute[]
  tokenHolders TokenHolder[]
  updates      Cast[]
  evidences    Evidence[]
  derivedData  DerivedData?

  @@map("Grant")
  @@schema("public")
}

view Vote {
  id          String @id
  contract    String
  recipientId String
  tokenId     String
  bps         Int
  voter       String
  blockNumber String
  isStale     Int
  votesCount  String

  @@schema("public")
}

view PonderMeta {
  key   String @id
  value String

  @@map("_ponder_meta")
  @@schema("public")
}

view Dispute {
  id                   String     @id
  disputeId            String
  arbitrator           String
  arbitrable           String
  grantId              String
  challenger           String
  votingStartTime      Int
  votingEndTime        Int
  revealPeriodEndTime  Int
  votes                String
  requesterPartyVotes  String
  challengerPartyVotes String
  ruling               Int
  creationBlock        Int
  totalSupply          String
  isExecuted           Int
  evidenceGroupID      String     @unique
  grant                Grant      @relation(fields: [grantId], references: [id])
  evidences            Evidence[]

  @@schema("public")
}

view DisputeVote {
  id          String  @id
  arbitrator  String
  disputeId   String
  commitHash  String
  voter       String
  choice      Int?
  votes       String?
  reason      String?
  committedAt Int
  revealedBy  String?
  revealedAt  Int?

  @@unique([disputeId, arbitrator, voter])
  @@schema("public")
}

view TokenHolder {
  id            String @id
  tokenContract String
  flow          Grant  @relation(fields: [tokenContract], references: [erc20])
  holder        String
  firstPurchase Int
  amount        String

  @@unique([tokenContract, holder])
  @@schema("public")
}

view Evidence {
  id              String @id
  arbitrator      String
  evidenceGroupID String
  evidence        String
  party           String
  blockNumber     String

  dispute Dispute @relation(fields: [evidenceGroupID], references: [evidenceGroupID])
  grant   Grant   @relation(fields: [evidenceGroupID], references: [evidenceGroupID])

  @@schema("public")
}
